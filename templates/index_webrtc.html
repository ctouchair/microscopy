<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Microscope Control System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <!-- WebRTC视频预览窗口 -->
            <div class="preview">
                <h3><i class="fas fa-camera"></i> WebRTC 显微镜预览</h3>
                <video id="webrtcVideo" autoplay playsinline muted style="width: 100%; height: auto; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 15px; background: linear-gradient(45deg, #1a1a1a, #2d2d2d);"></video>
                <div class="webrtc-status">
                    <span id="connectionStatus">正在连接...</span>
                    <span id="videoStats"></span>
                </div>
            </div>
            
            <!-- 辅助摄像头WebRTC预览 -->
            <div class="preview-cam1">
                <h3><i class="fas fa-video"></i> 辅助摄像头WebRTC预览</h3>
                <video id="webrtcVideoCam1" autoplay playsinline muted style="width: 100%; height: auto; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 15px; background: linear-gradient(45deg, #1a1a1a, #2d2d2d);"></video>
                <div class="webrtc-status">
                    <span id="connectionStatusCam1">正在连接...</span>
                    <span id="videoStatsCam1"></span>
                </div>
            </div>
            
            <div class="chart-controls">
                <h4><i class="fas fa-chart-line"></i> 实时位置监控</h4>
                <div class="chart-checkboxes">
                    <label><input type="checkbox" id="showX" checked> <i class="fas fa-arrows-alt-h"></i> X轴</label>
                    <label><input type="checkbox" id="showY" checked> <i class="fas fa-arrows-alt-v"></i> Y轴</label>
                    <label><input type="checkbox" id="showZ" checked> <i class="fas fa-arrows-alt"></i> Z轴</label>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="mainChart"></canvas>
            </div>
        </div>
        
        <div class="controls">
            <div class="controls-header">
                <h2><i class="fas fa-microscope"></i> WebRTC显微镜控制系统</h2>
            </div>
            
            <div class="button-row">
                <button id="capture" class="btn" onclick="captureScreenshot()">
                    <i class="fas fa-camera"></i><br>拍照
                </button>
                <button id="recordBtn" class="btn" onclick="toggleRecording()">
                    <i class="fas fa-video"></i><br>显微录制
                </button>
            </div>
            
            <div class="button-row">
                <button id="recordCam1Btn" class="btn" onclick="toggleCam1Recording()">
                    <i class="fas fa-video"></i><br>辅助录制
                </button>
            </div>
            
            <div class="button-row">
                <button id="fast_focus" class="btn" onclick="fast_forcus()">
                    <i class="fas fa-crosshairs"></i><br>快速对焦
                </button>
                <button id="save_config" class="btn" onclick="save_config()">
                    <i class="fas fa-save"></i><br>保存设置
                </button>
            </div>
            
            <div class="button-row">
                <button id="focus_stack" class="btn" onclick="focusStack()">
                    <i class="fas fa-layer-group"></i><br>景深堆叠
                </button>
                <button id="stitch_images" class="btn" onclick="stitch_images()">
                    <i class="fas fa-puzzle-piece"></i><br>400%拼接
                </button>
            </div>
            
            <div class="button-row">
                <div id="indicator" class="indicator indicator-full-width" title="电机静止时显示状态，运动时点击可立即停止">
                    <i class="fas fa-stop-circle" id="indicator-icon"></i>
                    <span id="indicator-text">静止</span>
                </div>
            </div>
            
            <div class="control-section">
                <h4><i class="fas fa-arrows-alt"></i> 位置控制</h4>
                
                <!-- X方向 -->
                <div class="position-row">
                    <span id="x_pos_value" class="slider-value">X目标位置：0.00 mm</span>
                    <span id="x_current" class="current-position">当前位置：0.000 mm</span>
                </div>
                <input type="range" id="x_pos" min="-9" max="6" step="0.01" value="0">

                <!-- Y方向 -->
                <div class="position-row">
                    <span id="y_pos_value" class="slider-value">Y目标位置：0.00 mm</span>
                    <span id="y_current" class="current-position">当前位置：0.000 mm</span>
                </div>
                <input type="range" id="y_pos" min="-9" max="7" step="0.01" value="0">

                <!-- Z方向 -->
                <div class="position-row">
                    <span id="z_pos_value" class="slider-value">Z目标位置：0.000 mm</span>
                    <span id="z_current" class="current-position">当前位置：0.000 mm</span>
                </div>
                <input type="range" id="z_pos" min="-5" max="5" step="0.001" value="0">
            </div>

            <div class="control-section">
                <h4><i class="fas fa-cog"></i> 相机设置</h4>
                
                <!-- 曝光时间和ISO增益 -->
                <div class="slider-row">
                    <div class="slider-group">
                        <span id="exposure_value" class="slider-value">曝光时间：10 ms</span>
                        <input type="range" id="exposure" min="0" max="500" step="5" value="20">
                    </div>
                    <div class="slider-group">
                        <span id="gain_value" class="slider-value">ISO增益：1</span>
                        <input type="range" id="gain" min="1" max="10" step="0.1" value="1.5">
                    </div>
                </div>

                <!-- LED亮度 -->
                <div class="slider-single">
                    <span id="led_value" class="slider-value">LED亮度：0</span>
                    <input type="range" id="led" min="0" max="100" step="1" value="10">
                </div>

                <!-- 录制延迟 -->
                <div class="slider-single">
                    <span id="delay_value" class="slider-value">间隔录制：0 秒</span>
                    <input type="range" id="delay" min="0" max="10" step="0.2" value="0">
                </div>

                <!-- 白平衡增益 R 和 B -->
                <div class="slider-row">
                    <div class="slider-group">
                        <span id="r_bal_value" class="slider-value">白平衡红色增益：0.85</span>
                        <input type="range" id="r_bal" min="0.5" max="1" step="0.01" value="0.85">
                    </div>
                    <div class="slider-group">
                        <span id="b_bal_value" class="slider-value">白平衡蓝色增益：0.95</span>
                        <input type="range" id="b_bal" min="0.5" max="1" step="0.01" value="0.95">
                    </div>
                </div>


                
                <!-- 校准按钮 -->
                <div class="button-row">
                    <button id="calibrate" class="btn" onclick="calibrateSystem()">
                        <i class="fas fa-ruler"></i><br>系统校准
                    </button>
                    <button id="cell_count" class="btn" onclick="cellCount()">
                        <i class="fas fa-microscope"></i><br>细胞计数
                    </button>
                </div>
            </div>
            
            <!-- 系统日志窗口 -->
            <div class="log-container">
                <div class="log-header">
                    <h4><i class="fas fa-terminal"></i> 系统日志</h4>
                    <div class="log-controls">
                        <button id="clearLog" class="log-btn" onclick="clearLog()">
                            <i class="fas fa-trash"></i> 清空
                        </button>
                        <button id="toggleLog" class="log-btn" onclick="toggleLog()">
                            <i class="fas fa-chevron-up"></i> 收起
                        </button>
                    </div>
                </div>
                <div id="logContent" class="log-content">
                    <div class="log-message welcome">WebRTC系统启动完成，等待连接...</div>
                </div>
            </div>
        </div>
    </div>
    <script src="{{ url_for('static', filename='js/webrtc_script.js') }}"></script>
</body>
</html> 