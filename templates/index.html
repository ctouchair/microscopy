<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microscope Control System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <div class="preview">
                <h3><i class="fas fa-camera"></i> 主摄像头预览</h3>
                <canvas id="videoCanvas" width="1014" height="760"></canvas>
                <img id="videoFeed" src="{{ url_for('video_feed') }}" alt="Video Feed" style="display: none;"/>
            </div>
            <div class="preview-cam1">
                <div class="cam1-header">
                    <h3><i class="fas fa-video"></i> 辅助摄像头预览</h3>
                    <div class="cam1-mode-selector">
                        <label class="mode-option">
                            <input type="radio" name="cam1Mode" value="normal" checked>
                            <span class="mode-label">正常模式</span>
                        </label>
                        <label class="mode-option">
                            <input type="radio" name="cam1Mode" value="corrected">
                            <span class="mode-label">校正模式</span>
                        </label>
                    </div>
                </div>
                <canvas id="videoCanvasCam1" width="820" height="616"></canvas>
                <img id="videoFeedCam1" src="{{ url_for('video_feed_cam1') }}" alt="Video Feed Cam1" style="display: none;"/>
            </div>
            <div class="chart-controls">
                <h4><i class="fas fa-chart-line"></i> 实时位置监控</h4>
                <div class="chart-checkboxes">
                    <label><input type="checkbox" id="showX" checked> <i class="fas fa-arrows-alt-h"></i> X轴</label>
                    <label><input type="checkbox" id="showY" checked> <i class="fas fa-arrows-alt-v"></i> Y轴</label>
                    <label><input type="checkbox" id="showZ" checked> <i class="fas fa-arrows-alt"></i> Z轴</label>
                    <label><input type="checkbox" id="showXyzDebug"> <i class="fas fa-bug"></i> 位置调试</label>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="mainChart"></canvas>
            </div>
        </div>
        <div class="controls">
            <div class="controls-header">
                <h2><i class="fas fa-microscope"></i> 显微镜控制系统</h2>
            </div>
            
            <div class="button-row">
                <button id="capture" class="btn" onclick="captureScreenshot()">
                    <i class="fas fa-camera"></i><br>拍照
                </button>
                <button id="recordBtn" class="btn" onclick="toggleRecording()">
                    <i class="fas fa-video"></i><br>显微录制
                </button>
            </div>
            
            <div class="button-row">
                <button id="autoBrightnessBtn0" class="btn" onclick="autoBrightness(0)">
                    <i class="fas fa-lightbulb"></i><br>反射自动亮度
                </button>
                <button id="autoBrightnessBtn1" class="btn" onclick="autoBrightness(1)">
                    <i class="fas fa-sun"></i><br>透射自动亮度
                </button>
            </div>
            
            <div class="button-row">
                <button id="captureCam1Btn" class="btn" onclick="captureCam1Screenshot()">
                    <i class="fas fa-camera"></i><br>辅助拍照
                </button>
                <button id="recordCam1Btn" class="btn" onclick="toggleCam1Recording()">
                    <i class="fas fa-video"></i><br>辅助录制
                </button>
            </div>
            
            <div class="button-row">
                <button id="fast_focus" class="btn" onclick="fast_forcus()">
                    <i class="fas fa-crosshairs"></i><br>快速对焦
                </button>
                <button id="save_config" class="btn" onclick="save_config()">
                    <i class="fas fa-save"></i><br>保存设置
                </button>
            </div>
            
            <div class="button-row">
                <button id="focus_stack" class="btn" onclick="focusStack()">
                    <i class="fas fa-layer-group"></i><br>景深堆叠
                </button>
                <button id="stitch_images" class="btn" onclick="stitch_images()">
                    <i class="fas fa-puzzle-piece"></i><br>400%拼接
                </button>
            </div>
            
            <div class="button-row">
                <div id="indicator" class="indicator indicator-full-width" title="点击停止电机运动">
                    <i class="fas fa-stop-circle" id="indicator-icon"></i>
                    <span id="indicator-text">静止</span>
                </div>
            </div>
            
            <div class="control-section">
                <h4><i class="fas fa-arrows-alt"></i> 位置控制</h4>
                
                <!-- X方向 -->
                <div class="position-row">
                    <span id="x_value" class="slider-value">X目标位置：0.00 mm</span>
                    <span id="x_current" class="current-position">当前位置：0.000 mm</span>
                </div>
                <input type="range" id="x_pos" min="0" max="18" step="0.01" value="0">
                
                <!-- X轴步进控制 -->
                <div class="xy-step-control">
                    <button class="step-btn" onclick="moveXLeft()">
                        <i class="fas fa-chevron-left"></i> 左
                    </button>
                    <div class="step-input-wrapper">
                        <input type="number" id="xStepSize" class="step-input" value="50" min="50" step="1" placeholder="步长">
                        <span class="step-unit">μm</span>
                    </div>
                    <button class="step-btn" onclick="moveXRight()">
                        <i class="fas fa-chevron-right"></i> 右
                    </button>
                </div>

                <!-- Y方向 -->
                <div class="position-row">
                    <span id="y_value" class="slider-value">Y目标位置：0.00 mm</span>
                    <span id="y_current" class="current-position">当前位置：0.000 mm</span>
                </div>
                <input type="range" id="y_pos" min="0" max="18" step="0.01" value="0">
                
                <!-- Y轴步进控制 -->
                <div class="xy-step-control">
                    <button class="step-btn" onclick="moveYDown()">
                        <i class="fas fa-chevron-down"></i> 下
                    </button>
                    <div class="step-input-wrapper">
                        <input type="number" id="yStepSize" class="step-input" value="50" min="50" step="1" placeholder="步长">
                        <span class="step-unit">μm</span>
                    </div>
                    <button class="step-btn" onclick="moveYUp()">
                        <i class="fas fa-chevron-up"></i> 上
                    </button>
                </div>

                <!-- Z方向 -->
                <div class="position-row">
                    <span id="z_value" class="slider-value">Z目标位置：0.000 mm</span>
                    <span id="z_current" class="current-position">当前位置：0.000 mm</span>
                </div>
                <input type="range" id="z_pos" min="0" max="10" step="0.001" value="0">
                
                <!-- Z轴步进控制 -->
                <div class="xy-step-control">
                    <button class="step-btn" onclick="moveZBackward()">
                        <i class="fas fa-chevron-left"></i> 后退
                    </button>
                    <div class="step-input-wrapper">
                        <input type="number" id="zStepSize" class="step-input" value="2" min="1" step="1" placeholder="步长">
                        <span class="step-unit">μm</span>
                    </div>
                    <button class="step-btn" onclick="moveZForward()">
                        <i class="fas fa-chevron-right"></i> 前进
                    </button>
                </div>
            </div>

            <div class="control-section">
                <h4><i class="fas fa-cog"></i> 相机设置</h4>
                
                <!-- 曝光时间和ISO增益 -->
                <div class="slider-row">
                    <div class="slider-group">
                        <span id="exposure_value" class="slider-value">曝光时间：10 ms</span>
                        <input type="range" id="exposure" min="0" max="500" step="5" value="20">
                    </div>
                    <div class="slider-group">
                        <span id="gain_value" class="slider-value">ISO增益：1</span>
                        <input type="range" id="gain" min="1" max="10" step="0.1" value="1.5">
                    </div>
                </div>

                <!-- LED亮度控制 -->
                <div class="slider-row">
                    <div class="slider-group">
                        <span id="led_value_0" class="slider-value">反射亮度：0</span>
                        <input type="range" id="led_0" min="0" max="20" step="1" value="0">
                    </div>
                    <div class="slider-group">
                        <span id="led_value_1" class="slider-value">透射亮度：0</span>
                        <input type="range" id="led_1" min="0" max="50" step="1" value="0">
                    </div>
                </div>

                <!-- 白平衡增益 R 和 B -->
                <div class="slider-row">
                    <div class="slider-group">
                        <span id="r_value" class="slider-value">白平衡红色增益：0.674</span>
                        <input type="range" id="r_bal" min="0.5" max="1" step="0.01">
                    </div>
                    <div class="slider-group">
                        <span id="b_value" class="slider-value">白平衡蓝色增益：0.576</span>
                        <input type="range" id="b_bal" min="0.5" max="1" step="0.01">
                    </div>
                </div>

                <!-- 延迟拍摄 -->
                <div class="slider-single">
                    <span id="delay_value" class="slider-value">间隔录制：0 秒</span>
                    <input type="range" id="delay" min="0" max="10" step="0.2" value="0">
                </div>
                
                <!-- 景深堆叠Z Level参数 -->
                <div class="slider-single">
                    <span id="z_level_value" class="slider-value">景深堆叠Z Level：5 微米</span>
                    <input type="range" id="z_level" min="1" max="50" step="1" value="5">
                </div>
                
                <!-- 细胞计数按钮和显微镜倍率选择 -->
                <div class="button-row">
                    <button id="cell_count" class="btn" onclick="cellCount()">
                        <i class="fas fa-microscope"></i><br>细胞计数
                    </button>
                    <button id="magnification" class="btn magnification-btn" onclick="cycleMagnification()">
                        <i class="fas fa-search-plus"></i><br><span class="magnification-label">物镜倍率</span><br><span id="magnification-text">40倍</span>
                    </button>
                </div>
                
                <!-- WiFi设置按钮 -->
                <div class="button-row">
                    <button id="wifiBtn" class="btn" onclick="openWifiModal()">
                        <i class="fas fa-wifi"></i><br>WiFi设置
                    </button>
                    <button id="updateBtn" class="btn" onclick="openUpdateModal()">
                        <i class="fas fa-download"></i><br>系统更新
                    </button>
                </div>
            </div>
            
            <!-- 系统日志窗口 -->
            <div class="log-container">
                <div class="log-header">
                    <h4><i class="fas fa-terminal"></i> 系统日志</h4>
                    <div class="log-controls">
                        <button id="clearLog" class="log-btn" onclick="clearLog()">
                            <i class="fas fa-trash"></i> 清空
                        </button>
                        <button id="toggleLog" class="log-btn" onclick="toggleLog()">
                            <i class="fas fa-chevron-up"></i> 收起
                        </button>
                    </div>
                </div>
                <div id="logContent" class="log-content">
                    <div class="log-message welcome">系统启动完成，等待连接...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- WiFi设置模态框 -->
    <div id="wifiModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-wifi"></i> WiFi网络设置</h3>
                <span class="close" onclick="closeWifiModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="wifi-section">
                    <div class="wifi-status">
                        <h4><i class="fas fa-signal"></i> 当前连接状态</h4>
                        <div id="currentWifiStatus" class="status-info">
                            <div class="status-item">
                                <span class="status-label">网络名称：</span>
                                <span id="currentSSID">检查中...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">IP地址：</span>
                                <span id="currentIP">检查中...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">信号强度：</span>
                                <span id="currentSignal">检查中...</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="wifi-scan">
                        <div class="scan-header">
                            <h4><i class="fas fa-search"></i> 可用网络</h4>
                            <button id="scanBtn" class="scan-btn" onclick="scanWifiNetworks()">
                                <i class="fas fa-sync-alt"></i> 扫描
                            </button>
                        </div>
                        <div id="wifiList" class="wifi-list">
                            <div class="loading">正在扫描WiFi网络...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WiFi连接模态框 -->
    <div id="wifiConnectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-key"></i> 连接到WiFi网络</h3>
                <span class="close" onclick="closeWifiConnectModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="connect-form">
                    <div class="form-group">
                        <label for="connectSSID">网络名称 (SSID)：</label>
                        <input type="text" id="connectSSID" readonly>
                    </div>
                    <div class="form-group">
                        <label for="connectPassword">密码：</label>
                        <div class="password-input">
                            <input type="password" id="connectPassword" placeholder="请输入WiFi密码">
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility()">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button id="connectBtn" class="btn-primary" onclick="connectToWifi()">
                            <i class="fas fa-wifi"></i> 连接
                        </button>
                        <button class="btn-secondary" onclick="closeWifiConnectModal()">
                            取消
                        </button>
                    </div>
                </div>
                <div id="connectStatus" class="connect-status"></div>
            </div>
        </div>
    </div>

    <!-- 系统更新模态框 -->
    <div id="updateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-download"></i> 系统更新</h3>
                <span class="close" onclick="closeUpdateModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="update-section">
                    <!-- 当前版本信息 -->
                    <div class="version-info">
                        <h4><i class="fas fa-info-circle"></i> 版本信息</h4>
                        <div class="version-details">
                            <div class="version-item">
                                <span class="version-label">当前版本:</span>
                                <span id="currentVersion" class="version-value">检查中...</span>
                            </div>
                            <div class="version-item">
                                <span class="version-label">最新版本:</span>
                                <span id="latestVersion" class="version-value">检查中...</span>
                            </div>
                            <div class="version-item">
                                <span class="version-label">更新时间:</span>
                                <span id="updateDate" class="version-value">-</span>
                            </div>
                            <div class="version-item">
                                <span class="version-label">更新内容:</span>
                                <span id="updateMessage" class="version-value">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- 更新控制 -->
                    <div class="update-controls">
                        <div class="update-buttons">
                            <button id="checkUpdateBtn" class="btn-primary" onclick="checkForUpdates()">
                                <i class="fas fa-search"></i> 检查更新
                            </button>
                            <button id="performUpdateBtn" class="btn-primary" onclick="performUpdate()" disabled>
                                <i class="fas fa-download"></i> 开始更新
                            </button>
                        </div>
                    </div>

                    <!-- 更新进度 -->
                    <div id="updateProgress" class="update-progress" style="display: none;">
                        <h4><i class="fas fa-cog fa-spin"></i> 更新进度</h4>
                        <div class="progress-info">
                            <div class="progress-item">
                                <span class="progress-label">当前状态:</span>
                                <span id="updateStatusText" class="progress-value">准备中...</span>
                            </div>
                            <div class="progress-bar">
                                <div id="progressFill" class="progress-fill"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 更新结果 -->
                    <div id="updateResult" class="update-result" style="display: none;">
                        <div id="updateResultContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>
</html>
